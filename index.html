<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>NVDSP by bartolsthoorn</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">NVDSP</h1>
      <h2 class="project-tagline">iOS/OSX DSP for audio (Novocaine)</h2>
      <a href="https://github.com/bartolsthoorn/NVDSP" class="btn">View on GitHub</a>
      <a href="https://github.com/bartolsthoorn/NVDSP/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/bartolsthoorn/NVDSP/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h2>
<a id="audio-filters-on-ios-and-osx" class="anchor" href="#audio-filters-on-ios-and-osx" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Audio Filters on iOS and OSX</h2>

<p>Implement high quality audio filters with just a few lines of code and <a href="https://github.com/alexbw/novocaine">Novocaine</a>, or your own audio library of choice.</p>

<p>NVDSP comes with a wide variety of audio filters:</p>

<ul>
<li>All Pass Filter (NVAllpassFilter)</li>
<li>Band Pass Filter, 0dB gain (NVBandpassFilter)</li>
<li>Band Pass Filter, Q gain (NVBandpassQPeakGainFilter)</li>
<li>High Pass Filter (NVHighpassFilter)</li>
<li>High Shelving Filter (NVHighShelvingFilter)</li>
<li>Low Shelving Filter (NVLowShelvingFilter)</li>
<li>Low Pass Filter (NVLowPassFilter)</li>
<li>Notch Filter (NVNotchFilter)</li>
<li>Peaking EQ Filter (NVPeakingEQFilter)</li>
</ul>

<h3>
<a id="combining-it-with-novocaine-highpass-filter" class="anchor" href="#combining-it-with-novocaine-highpass-filter" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Combining it with Novocaine (highpass filter)</h3>

<p>To start out I recommend you to get a fresh copy of <a href="https://github.com/alexbw/novocaine">Novocaine</a> and open Novocaine's excellent example project. Then import NVDSP and the Filters folder and start your filtering journey.</p>

<div class="highlight highlight-source-objc"><pre><span class="pl-c">// ... import Novocaine here ... </span>
#<span class="pl-k">import</span> <span class="pl-s"><span class="pl-pds">"</span>NVDSP/NVDSP.h<span class="pl-pds">"</span></span>
#<span class="pl-k">import</span> <span class="pl-s"><span class="pl-pds">"</span>NVDSP/Filters/NVHighpassFilter.h<span class="pl-pds">"</span></span>

<span class="pl-c">// init Novocaine audioManager</span>
audioManager = [Novocaine <span class="pl-c1">audioManager</span>];
<span class="pl-k">float</span> samplingRate = audioManager.samplingRate;

<span class="pl-c">// init fileReader which we will later fetch audio from</span>
<span class="pl-c1">NSURL</span> *inputFileURL = [[<span class="pl-c1">NSBundle</span> <span class="pl-c1">mainBundle</span>] <span class="pl-c1">URLForResource:</span><span class="pl-s"><span class="pl-pds">@"</span>Trentemoller-Miss-You<span class="pl-pds">"</span></span> <span class="pl-c1">withExtension:</span><span class="pl-s"><span class="pl-pds">@"</span>mp3<span class="pl-pds">"</span></span>];

fileReader = [[AudioFileReader <span class="pl-c1">alloc</span>] 
                  <span class="pl-c1">initWithAudioFileURL:</span>inputFileURL 
                  <span class="pl-c1">samplingRate:</span>audioManager.samplingRate
                  <span class="pl-c1">numChannels:</span>audioManager.numOutputChannels];

<span class="pl-c">// setup Highpass filter</span>
NVHighpassFilter *HPF;
HPF = [[NVHighpassFilter <span class="pl-c1">alloc</span>] <span class="pl-c1">initWithSamplingRate:</span>samplingRate];

HPF.cornerFrequency = <span class="pl-c1">2000</span>.<span class="pl-c1">0f</span>;
HPF.Q = <span class="pl-c1">0</span>.<span class="pl-c1">5f</span>;

<span class="pl-c">// setup audio output block</span>
[fileReader <span class="pl-c1">play</span>];
[audioManager <span class="pl-c1">setOutputBlock:</span>^(<span class="pl-k">float</span> *outData, <span class="pl-c1">UInt32</span> numFrames, <span class="pl-c1">UInt32</span> numChannels) {
    [fileReader <span class="pl-c1">retrieveFreshAudio:</span>outData <span class="pl-c1">numFrames:</span>numFrames <span class="pl-c1">numChannels:</span>numChannels];

    [HPF <span class="pl-c1">filterData:</span>outData <span class="pl-c1">numFrames:</span>numFrames <span class="pl-c1">numChannels:</span>numChannels];
}];</pre></div>

<p>Note that NVDSP works with raw audio buffers, so it can also work with other libraries instead of Novocaine.</p>

<h3>
<a id="more-examples" class="anchor" href="#more-examples" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>More examples</h3>

<h4>
<a id="peaking-eq-filter" class="anchor" href="#peaking-eq-filter" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Peaking EQ filter</h4>

<div class="highlight highlight-source-objc"><pre><span class="pl-c">// import Novocaine.h and NVDSP.h</span>
#<span class="pl-k">import</span> <span class="pl-s"><span class="pl-pds">"</span>NVDSP/Filter/NVPeakingEQFilter.h<span class="pl-pds">"</span></span>
NVPeakingEQFilter *PEF = [[NVPeakingEQFilter <span class="pl-c1">alloc</span>] <span class="pl-c1">initWithSamplingRate:</span>audioManager.samplingRate];
PEF.centerFrequency = <span class="pl-c1">1000</span>.<span class="pl-c1">0f</span>;
PEF.Q = <span class="pl-c1">3</span>.<span class="pl-c1">0f</span>;
PEF.G = <span class="pl-c1">20</span>.<span class="pl-c1">0f</span>;
[PEF <span class="pl-c1">filterData:</span>data <span class="pl-c1">numFrames:</span>numFrames <span class="pl-c1">numChannels:</span>numChannels];</pre></div>

<h4>
<a id="lowpass-filter" class="anchor" href="#lowpass-filter" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Lowpass filter</h4>

<div class="highlight highlight-source-objc"><pre><span class="pl-c">// import Novocaine.h and NVDSP.h</span>
#<span class="pl-k">import</span> <span class="pl-s"><span class="pl-pds">"</span>NVDSP/Filter/NVLowpassFilter.h<span class="pl-pds">"</span></span>
NVLowpassFilter *LPF = [[NVLowpassFilter <span class="pl-c1">alloc</span>] <span class="pl-c1">initWithSamplingRate:</span>audioManager.samplingRate];
LPF.cornerFrequency = <span class="pl-c1">800</span>.<span class="pl-c1">0f</span>;
LPF.Q = <span class="pl-c1">0</span>.<span class="pl-c1">8f</span>;
[LPF <span class="pl-c1">filterData:</span>data <span class="pl-c1">numFrames:</span>numFrames <span class="pl-c1">numChannels:</span>numChannels];</pre></div>

<h4>
<a id="notch-filter" class="anchor" href="#notch-filter" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Notch filter</h4>

<div class="highlight highlight-source-objc"><pre><span class="pl-c">// import Novocaine.h and NVDSP.h</span>
#<span class="pl-k">import</span> <span class="pl-s"><span class="pl-pds">"</span>NVDSP/Filter/NVNotchFilter.h<span class="pl-pds">"</span></span>
NVNotchFilter *NF = [[NVNotchFilter <span class="pl-c1">alloc</span>] <span class="pl-c1">initWithSamplingRate:</span>audioManager.samplingRate];
NF.centerFrequency = <span class="pl-c1">3000</span>.<span class="pl-c1">0f</span>;
NF.Q = <span class="pl-c1">0</span>.<span class="pl-c1">8f</span>;
[NF <span class="pl-c1">filterData:</span>data <span class="pl-c1">numFrames:</span>numFrames <span class="pl-c1">numChannels:</span>numChannels];</pre></div>

<h4>
<a id="bandpass-filter" class="anchor" href="#bandpass-filter" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Bandpass filter</h4>

<p>There are two types of bandpass filters:</p>

<pre><code>* 0 dB gain bandpass filter (NVBandpassFilter.h)
* Peak gain Q bandpass filter (NVBandpassQPeakGainFilter.h)
</code></pre>

<div class="highlight highlight-source-objc"><pre><span class="pl-c">// import Novocaine.h and NVDSP.h</span>
#<span class="pl-k">import</span> <span class="pl-s"><span class="pl-pds">"</span>NVDSP/Filter/NVBandpassFilter.h<span class="pl-pds">"</span></span>
NVBandpassFilter *BPF = [[NVBandpassFilter <span class="pl-c1">alloc</span>] <span class="pl-c1">initWithSamplingRate:</span>audioManager.samplingRate];
BPF.centerFrequency = <span class="pl-c1">2500</span>.<span class="pl-c1">0f</span>;
BPF.Q = <span class="pl-c1">0</span>.<span class="pl-c1">9f</span>;
[BPF <span class="pl-c1">filterData:</span>data <span class="pl-c1">numFrames:</span>numFrames <span class="pl-c1">numChannels:</span>numChannels];</pre></div>

<h4>
<a id="measure-db-level-ranging-from--510f-to-00f" class="anchor" href="#measure-db-level-ranging-from--510f-to-00f" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Measure dB level (ranging from -51.0f to 0.0f)</h4>

<div class="highlight highlight-source-objc"><pre><span class="pl-c">// import Novocaine.h and NVDSP.h</span>
#<span class="pl-k">import</span> <span class="pl-s"><span class="pl-pds">"</span>NVDSP/Utilities/NVSoundLevelMeter.h<span class="pl-pds">"</span></span>
NVSoundLevelMeter *SLM = [[NVSoundLevelMeter <span class="pl-c1">alloc</span>] <span class="pl-c1">init</span>];
<span class="pl-k">float</span> dB = [SLM <span class="pl-c1">getdBLevel:</span>outData <span class="pl-c1">numFrames:</span>numFrames <span class="pl-c1">numChannels:</span>numChannels];
<span class="pl-c1">NSLog</span>(<span class="pl-s"><span class="pl-pds">@"</span>dB level: <span class="pl-c1">%f</span><span class="pl-pds">"</span></span>, dB);
<span class="pl-c">// NSLogging in an output loop will most likely cause hickups/clicky noises, but it does log the dB level!</span>
<span class="pl-c">// To get a proper dB value, you have to call the getdBLevel method a few times (it has memory of previous values)</span>
<span class="pl-c">// You call this inside the input or outputBlock: [audioManager setOutputBlock:^...</span></pre></div>

<h4>
<a id="applying-overall-gain" class="anchor" href="#applying-overall-gain" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Applying overall gain.</h4>

<p>All sample values (typically -1.0f .. 1.0f when not clipping) are multiplied by the gain value.</p>

<div class="highlight highlight-source-objc"><pre><span class="pl-c">// import Novocaine.h and NVDSP.h</span>
NVDSP *generalDSP = [[NVDSP <span class="pl-c1">alloc</span>] <span class="pl-c1">init</span>];
[generalDSP <span class="pl-c1">applyGain:</span>outData <span class="pl-c1">length:</span>numFrames*numChannels <span class="pl-c1">gain:</span><span class="pl-c1">0.8</span>];</pre></div>

<h4>
<a id="convert-stereo-leftright-to-mono" class="anchor" href="#convert-stereo-leftright-to-mono" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Convert stereo (left/right) to mono</h4>

<p>This converts a left and right buffer into a mono signal. It takes the average of the samples.</p>

<div class="highlight highlight-source-objc"><pre><span class="pl-c">// Deinterleave stereo buffer into seperate left and right</span>
<span class="pl-k">float</span> *left = (<span class="pl-k">float</span> *)malloc((numFrames + <span class="pl-c1">2</span>) * <span class="pl-k">sizeof</span>(<span class="pl-k">float</span>));
<span class="pl-k">float</span> *right = (<span class="pl-k">float</span> *)malloc((numFrames + <span class="pl-c1">2</span>) * <span class="pl-k">sizeof</span>(<span class="pl-k">float</span>));
[generalDSP <span class="pl-c1">deinterleave:</span>data <span class="pl-c1">left:</span>left <span class="pl-c1">right:</span>right <span class="pl-c1">length:</span>numFrames];

<span class="pl-c">// Convert left and right to a mono 2 channel buffer</span>
[generalDSP <span class="pl-c1">mono:</span>data <span class="pl-c1">left:</span>left <span class="pl-c1">right:</span>right <span class="pl-c1">length:</span>numFrames];

<span class="pl-c">// Free buffers</span>
<span class="pl-en">free</span>(left);
<span class="pl-en">free</span>(right);</pre></div>

<h3>
<a id="clipping" class="anchor" href="#clipping" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Clipping</h3>

<p>Multiple peaking EQs with high gains can cause clipping. Clipping is basically sample data that exceeds the maximum or minimum value of 1.0f or -1.0f respectively. Clipping will cause really loud and dirty noises, like a bad overdrive effect. You can use the method <code>counterClipping</code> to prevent clipping (it will reduce the sound level).</p>

<div class="highlight highlight-source-objc"><pre><span class="pl-c">// import Novocaine.h and NVDSP.h</span>
#<span class="pl-k">import</span> <span class="pl-s"><span class="pl-pds">"</span>NVDSP/Utilities/NVClippingDetection.h<span class="pl-pds">"</span></span>
NVClippingDetection *CDT = [[NVClippingDetection <span class="pl-c1">alloc</span>] <span class="pl-c1">init</span>];
<span class="pl-c">// ... possible clipped outData ...//</span>
[CDT <span class="pl-c1">counterClipping:</span>outData <span class="pl-c1">numFrames:</span>numFrames <span class="pl-c1">numChannels:</span>numChannels];
<span class="pl-c">// ... outData is now safe ...//</span>

<span class="pl-c">// or get the amount of clipped samples:</span>
 - (<span class="pl-k">float</span>) getClippedSamples:(<span class="pl-k">float</span> *)data numFrames:(<span class="pl-c1">UInt32</span>)numFrames numChannels:(<span class="pl-c1">UInt32</span>)numChannels;
<span class="pl-c">// or get the percentage of clipped samples:</span>
 - (<span class="pl-k">float</span>) getClippedPercentage:(<span class="pl-k">float</span>*)data numFrames:(<span class="pl-c1">UInt32</span>)numFrames numChannels:(<span class="pl-c1">UInt32</span>)numChannels;
<span class="pl-c">// or get the maximum value of a clipped sample that was found</span>
 - (<span class="pl-k">float</span>) getClippingSample:(<span class="pl-k">float</span> *)data numFrames:(<span class="pl-c1">UInt32</span>)numFrames numChannels:(<span class="pl-c1">UInt32</span>)numChannels;</pre></div>

<h3>
<a id="example-project" class="anchor" href="#example-project" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Example project</h3>

<p>See <code>/Examples/NVDSPExample</code> for a simple iOS XcodeProject example. Please note the Novocaine bundled with it might be outdated.</p>

<h3>
<a id="a-thing-to-note" class="anchor" href="#a-thing-to-note" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>A thing to note</h3>

<p>The NVDSP class is written in C++, so the classes that use it will have to be Objective-C++. Change all the files that use NVDSP from MyClass.m to MyClass.mm.</p>

<h3>
<a id="thanks-to" class="anchor" href="#thanks-to" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Thanks to</h3>

<p>Alex Wiltschko - Creator of <a href="http://alexbw.github.com/novocaine/">Novocaine</a></p>

<p>Yasoshima - Writer of <a href="http://objective-audio.jp/2008/02/biquad-filter.html">this article</a>, revealing how vDSP_deq22 works. (and google translate, I don't speak Japanese)</p>

<p>hrnt - Helpful on IRC #iphonedev (freenode)</p>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/bartolsthoorn/NVDSP">NVDSP</a> is maintained by <a href="https://github.com/bartolsthoorn">bartolsthoorn</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

            <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-5535798-10");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>
